package com.ydl.web.controller.schedule;

import com.ydl.common.core.controller.BaseController;
import com.ydl.common.core.domain.AjaxResult;
import com.ydl.common.exception.ServiceException;
import com.ydl.common.utils.DateUtils;
import com.ydl.common.utils.bean.BeanUtils;
import com.ydl.common.utils.uuid.IdUtils;
import com.ydl.nmis.base.domain.NmisDeptDict;
import com.ydl.nmis.base.service.INmisDeptDictService;
import com.ydl.nmis.schedule.domain.NmisScheDetail;
import com.ydl.nmis.schedule.domain.NmisScheMaster;
import com.ydl.nmis.schedule.domain.NmisSchePlan;
import com.ydl.nmis.schedule.dto.*;
import com.ydl.nmis.schedule.service.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;
import org.springframework.web.bind.annotation.*;

import java.util.*;
import java.util.stream.Collectors;


@RestController
@RequestMapping("/schedule/week")
public class NmisScheWeekController extends BaseController
{
    @Autowired
    private INmisScheMasterService scheMasterService;
    @Autowired
    private INmisSchePlanService schePlanService;
    @Autowired
    private INmisScheDetailService scheDetailService;
    @Autowired
    private INmisScheGroupUserService scheGroupUserService;
    @Autowired
    private INmisDeptDictService deptDictService;
    @GetMapping("/list")
    public SchePlan getSchedule(
            @RequestParam(required = true) String deptId,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate
    ) {
       if(deptId == null || deptId.isEmpty()){
           throw new ServiceException("科室ID不能为空！");
       }
        NmisDeptDict deptDict = deptDictService.selectNmisDeptDictByCode(deptId);
        NmisSchePlan query = new NmisSchePlan();
        query.setDeptId(deptId);
        query.setBeginDate(startDate);
        query.setEndDate(endDate);
       List<NmisSchePlan> planList = schePlanService.selectNmisSchePlanList(query);
       if(CollectionUtils.isEmpty(planList)){
           SchePlan schePlan = new SchePlan();
           schePlan.setDeptId(deptId);
           schePlan.setDeptName(deptDict.getDeptName());
           schePlan.setBeginDate(startDate);
           schePlan.setEndDate(endDate);
           schePlan.setScheduleType("1");
           schePlan.setPeriodType("1");

           schePlan.setPeriodId(String.valueOf(DateUtils.getWeekNo(startDate)));
           List<DeptScheGroupUser> deptGroupUsers = scheGroupUserService.selectDeptScheGroupUserList(deptId);
           Map<ScheGroupKey, List<DeptScheGroupUser>> groupedResult = deptGroupUsers.stream()
                   .collect(Collectors.groupingBy(
                           item -> new ScheGroupKey(item.getGroupId(), item.getGroupName())
                   ));

           // 对分组结果按 groupId 正序排序
           List<Map.Entry<ScheGroupKey, List<DeptScheGroupUser>>> sortedResult = groupedResult.entrySet().stream()
                   .sorted(Map.Entry.comparingByKey()) // 按照 GroupKey 的自然顺序排序
                   .collect(Collectors.toList());
           List<ScheUserGroup> groups = new ArrayList<>();
           schePlan.setGroups(groups);
           for (Map.Entry<ScheGroupKey, List<DeptScheGroupUser>> entry : sortedResult) {
               ScheGroupKey key = entry.getKey();
               ScheUserGroup group = new ScheUserGroup();
               group.setGroupId(key.getGroupId());
               group.setGroupName(key.getGroupName());
               List<ScheUser> groupUsers = new ArrayList<>();
               for (DeptScheGroupUser master : entry.getValue()) {
                   ScheUser scheUser = new ScheUser();
                   BeanUtils.copyBeanProp(scheUser, master);
                   groupUsers.add(scheUser);
                   Date beginDate = DateUtils.parseDate(startDate);
                   for (int i = 1; i <= 7; i++)  {
                       ScheDetail detailTmp = new ScheDetail();
                       detailTmp.setScheDate(DateUtils.addDays(beginDate, i-1));
                       if(i == 1){
                           scheUser.setDay1(detailTmp);
                       }else if(i == 2){
                           scheUser.setDay2(detailTmp);
                       }else if(i == 3){
                           scheUser.setDay3(detailTmp);
                       }else if(i == 4){
                           scheUser.setDay4(detailTmp);
                       }else if(i == 5){
                           scheUser.setDay5(detailTmp);
                       }else if(i == 6){
                           scheUser.setDay6(detailTmp);
                       }else{
                           scheUser.setDay7(detailTmp);
                       }
                   }
               }
               group.setGroupUsers(groupUsers);
               groups.add(group);
           }


           //根据科室取科室参与排班的组和用户，
           return schePlan;
       }else{
           NmisSchePlan plan = planList.get(0);
           NmisScheMaster masterQuery = new NmisScheMaster();
           masterQuery.setPlanId(plan.getId());
           List<NmisScheMaster> masterList = scheMasterService.selectNmisScheMasterList(masterQuery);

           NmisScheDetail detailQuery = new NmisScheDetail();
           detailQuery.setPlanId(plan.getId());
           List<NmisScheDetail> detailList = scheDetailService.selectNmisScheDetailList(detailQuery);

           SchePlan schePlan = new SchePlan();
           BeanUtils.copyBeanProp(schePlan, plan);

           Map<ScheGroupKey, List<NmisScheMaster>> groupedResult = masterList.stream()
                   .collect(Collectors.groupingBy(
                           item -> new ScheGroupKey(item.getGroupId(), item.getGroupName())
                   ));

           // 对分组结果按 groupId 正序排序
           List<Map.Entry<ScheGroupKey, List<NmisScheMaster>>> sortedResult = groupedResult.entrySet().stream()
                   .sorted(Map.Entry.comparingByKey()) // 按照 GroupKey 的自然顺序排序
                   .collect(Collectors.toList());

           List<ScheUserGroup> groups = new ArrayList<>();
           schePlan.setGroups(groups);
           for (Map.Entry<ScheGroupKey, List<NmisScheMaster>> entry : sortedResult) {
               ScheGroupKey key = entry.getKey();

               ScheUserGroup group = new ScheUserGroup();
               group.setGroupId(key.getGroupId());
               group.setGroupName(key.getGroupName());


               List<ScheUser> groupUsers = new ArrayList<>();
               for (NmisScheMaster master : entry.getValue()) {
                   ScheUser scheUser = new ScheUser();
                   BeanUtils.copyBeanProp(scheUser, master);
                   groupUsers.add(scheUser);
                   // scheUser中添加day1到day7
                   List<NmisScheDetail> filterDetailList = detailList.stream().filter(x->scheUser.getId().equals(x.getSheduleId()))
                                    .sorted(Comparator.comparing(NmisScheDetail::getScheDate))
                                   .collect(Collectors.toList());
                   int idx = 1;
                   for (NmisScheDetail detail : filterDetailList) {
                       ScheDetail detailTmp = new ScheDetail();
                       BeanUtils.copyBeanProp(detailTmp, detail);
                       if(idx == 1){
                           scheUser.setDay1(detailTmp);
                       }else if(idx == 2){
                           scheUser.setDay2(detailTmp);
                       }else if(idx == 3){
                           scheUser.setDay3(detailTmp);
                       }else if(idx == 4){
                           scheUser.setDay4(detailTmp);
                       }else if(idx == 5){
                           scheUser.setDay5(detailTmp);
                       }else if(idx == 6){
                           scheUser.setDay6(detailTmp);
                       }else if(idx == 7){
                           scheUser.setDay7(detailTmp);
                       }
                       idx++;
                   }
               }
               group.setGroupUsers(groupUsers);
               groups.add(group);
           }

           return schePlan;
       }
    }

    @PostMapping("/add")
    @Transactional
    public AjaxResult SaveScheduleWeek(@RequestBody SchePlan schePlan){
        String planId = schePlan.getId();
        if(planId == null || planId.isEmpty()){
            addScheduleWeek(schePlan);

        }else{
            updateScheduleWeek(schePlan);
        }
        return AjaxResult.success();
    }

    private void addScheduleWeek(SchePlan schePlan) {
        NmisSchePlan plan = new NmisSchePlan();
        BeanUtils.copyBeanProp(plan, schePlan);
        String id = IdUtils.fastSimpleUUID().substring(0, 8);
        plan.setId(id);
        List<NmisScheMaster> masterList = new ArrayList<>();
        List<NmisScheDetail> detailList = new ArrayList<>();
        List<ScheUserGroup> groups = schePlan.getGroups();
        for(ScheUserGroup group : groups){
            List<ScheUser> groupUsers = group.getGroupUsers();
            for(ScheUser user : groupUsers)
            {
                NmisScheMaster master = new NmisScheMaster();
                BeanUtils.copyBeanProp(master, user);
                master.setPlanId(plan.getId());
                master.setId(IdUtils.fastSimpleUUID().substring(0, 8));
                master.setGroupId(group.getGroupId());
                master.setGroupId(group.getGroupName());
                masterList.add(master);
                for(int i = 0; i < 7; i++){
                    NmisScheDetail detail = new NmisScheDetail();
                    ScheDetail day = null;
                    if(i == 0){
                        day = user.getDay1();
                    }else if(i == 1){
                        day = user.getDay2();
                    }else if(i == 2){
                        day = user.getDay3();
                    }else if(i == 3){
                        day = user.getDay4();
                    }else if(i == 4){
                        day = user.getDay5();
                    }else if(i == 5){
                        day = user.getDay6();
                    }else {
                        day = user.getDay7();
                    }
                    BeanUtils.copyBeanProp(detail,day);
                    detail.setSheduleId(master.getId());
                    detail.setPlanId(plan.getId());
                    detail.setNurseId(master.getNurseId());
                    detail.setNurseName(master.getNurseName());
                    detail.setId(IdUtils.fastSimpleUUID().substring(0, 8));
                    detailList.add(detail);
                }
            }
        }
        //String userId = getUserId().toString();
        //String userName = getUsername();
        String userId = "333";
        String userName = "测试";
        Date now = new Date();
        plan.setDeptName(plan.getDeptName());
        plan.setCreateId(userId);
        plan.setCreator(userName);
        plan.setCreateDate(now);
        plan.setModifyId(userId);
        plan.setModifier(userName);
        plan.setModifyDate(now);
        schePlanService.insertNmisSchePlan(plan);
        for(NmisScheMaster master : masterList)
        {
            master.setDeptId(plan.getDeptId());
            master.setDeptName(plan.getDeptName());
            master.setCreateId(userId);
            master.setCreator(userName);
            master.setCreateDate(now);
            master.setModifyId(userId);
            master.setModifier(userName);
            master.setModifyDate(now);
            scheMasterService.insertNmisScheMaster(master);
        }
        for (NmisScheDetail detail : detailList)
        {
            detail.setDeptId(plan.getDeptId());
            detail.setDeptName(plan.getDeptName());
            detail.setCreateId(userId);
            detail.setCreator(userName);
            detail.setCreateDate(now);
            detail.setModifyId(userId);
            detail.setModifier(userName);
            detail.setModifyDate(now);
            scheDetailService.insertNmisScheDetail(detail);
        }
    }

    private void updateScheduleWeek(SchePlan schePlan) {
        String planId = schePlan.getId();
        NmisSchePlan plan = schePlanService.selectNmisSchePlanById(planId);
        BeanUtils.copyBeanProp(plan, schePlan);
        List<NmisScheMaster> masterList = new ArrayList<>();
        List<NmisScheDetail> detailList = new ArrayList<>();
        List<ScheUserGroup> groups = schePlan.getGroups();
        for(ScheUserGroup group : groups){
            List<ScheUser> groupUsers = group.getGroupUsers();
            for(ScheUser user : groupUsers)
            {
                NmisScheMaster master = scheMasterService.selectNmisScheMasterById(user.getId());
                BeanUtils.copyBeanProp(master, user);
                masterList.add(master);
                for(int i = 0; i < 7; i++){
                    ScheDetail day = null;
                    if(i == 0){
                        day = user.getDay1();
                    }else if(i == 1){
                        day = user.getDay2();
                    }else if(i == 2){
                        day = user.getDay3();
                    }else if(i == 3){
                        day = user.getDay4();
                    }else if(i == 4){
                        day = user.getDay5();
                    }else if(i == 5){
                        day = user.getDay6();
                    }else {
                        day = user.getDay7();
                    }
                    NmisScheDetail detail = scheDetailService.selectNmisScheDetailById(day.getId());
                    BeanUtils.copyBeanProp(detail,day);
                    detailList.add(detail);
                }
            }
        }
        //String userId = getUserId().toString();
        //String userName = getUsername();
        String userId = "333";
        String userName = "测试";
        Date now = new Date();
        plan.setModifyId(userId);
        plan.setModifier(userName);
        plan.setModifyDate(now);
        schePlanService.updateNmisSchePlan(plan);
        for(NmisScheMaster master : masterList)
        {
            master.setModifyId(userId);
            master.setModifier(userName);
            master.setModifyDate(now);
            scheMasterService.updateNmisScheMaster(master);
        }
        for (NmisScheDetail detail : detailList)
        {
            detail.setModifyId(userId);
            detail.setModifier(userName);
            detail.setModifyDate(now);
            scheDetailService.updateNmisScheDetail(detail);
        }
    }
}
