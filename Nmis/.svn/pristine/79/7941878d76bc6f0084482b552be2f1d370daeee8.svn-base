package com.ydl.nmis.schedule.service.impl;

import com.ydl.nmis.schedule.dto.*;
import com.ydl.nmis.schedule.mapper.ScheWeekDetail;
import com.ydl.nmis.schedule.service.ScheWeekDetailService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;

import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
public class ScheWeekDetailServiceImpl implements ScheWeekDetailService {

    @Autowired
    private ScheWeekDetail scheWeekDetail;

    @Override
    public List<ScheGroup> getAllGroups() {
        // 1. 查询基础组信息
        List<ScheGroup> groups = scheWeekDetail.selectBaseGroups();
        if (CollectionUtils.isEmpty(groups)) {
            return groups;
        }

        // 2. 为每个组查询成员信息
        groups.forEach(group -> {
            List<Member> members = scheWeekDetail.selectMembersByGroupId(group.getId());
            group.setChildren(members);
        });

        // 3. 查询所有成员的每日数据
        List<MemberDayDataDTO> allDayData = scheWeekDetail.selectMemberDayData();

        // 4. 按成员ID分组每日数据
        Map<String, List<MemberDayDataDTO>> memberDaysMap = allDayData.stream()
                .collect(Collectors.groupingBy(MemberDayDataDTO::getMemberId));

        // 5. 为每个成员设置day1-day7数据
        groups.forEach(group -> {
            if (!CollectionUtils.isEmpty(group.getChildren())) {
                group.getChildren().forEach(member -> {
                    List<MemberDayDataDTO> dayDataList = memberDaysMap.get(member.getId());
                    if (dayDataList != null) {
                        dayDataList.forEach(dto -> {
                            // 调整dayType映射关系
                            String adjustedDayType = adjustDayType(dto.getDayType(), dto.getScheDate());
                            member.setDayData(adjustedDayType, dto.getDayData());
                        });
                    }
                });
            }
        });

        return groups;
    }

    /**
     * 调整dayType映射关系
     * Oracle的TO_CHAR(date,'D')返回: 1=星期日,2=星期一,...,7=星期六
     * 根据业务需求转换为day1-day7
     */
    private String adjustDayType(String originalDayType, Date scheDate) {
        // 示例：将Oracle的星期几(1-7)转换为day1(周一)-day7(周日)
        try {
            int dayNum = Integer.parseInt(originalDayType.replace("day", ""));
            // Oracle: 1=周日,2=周一,...,7=周六
            // 转换为: day1=周一,...,day7=周日
            int adjustedDayNum = dayNum == 1 ? 7 : dayNum - 1;
            return "day" + adjustedDayNum;
        } catch (Exception e) {
            /*log.warn("无法解析dayType: {}", originalDayType);*/
            return originalDayType; // 保持原样或抛出异常
        }
    }
}