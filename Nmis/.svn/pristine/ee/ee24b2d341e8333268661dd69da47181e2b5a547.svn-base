<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ydl.nmis.schedule.mapper.ScheWeekDetail">

    <!-- 基础组信息查询 -->
    <select id="selectBaseGroups" resultType="com.ydl.nmis.schedule.dto.ScheGroup">
        SELECT
            c.id,
            c.group_name as name
        FROM nmis.nmis_sche_comp_dict c
    </select>

    <!-- 成员每日数据查询 -->
    <select id="selectMemberDayData" resultType="com.ydl.nmis.schedule.dto.MemberDayDataDTO">
        SELECT
        a.nurse_id as memberId,
        <!-- 使用Oracle的TO_CHAR函数从日期获取星期几(1-7) -->
        'day' || TO_CHAR(b.SCHE_DATE, 'D') as dayType,
        d.sche_name as "dayData.name",
        d.hours as "dayData.gs",
        b.sche_hours_change as "dayData.kj",
        b.SCHE_DATE as scheDate  <!-- 添加日期字段用于验证 -->
        FROM nmis.nmis_hr_user a
        JOIN nmis.nmis_sche_detail b ON a.nurse_id = b.nurse_id
        JOIN nmis.nmis_sche_dict d ON d.class_id = b.sche_item_id AND d.dept_id = b.dept_id
        <!-- 添加日期范围限制，确保只查询当周数据 -->
        WHERE b.SCHE_DATE BETWEEN TRUNC(SYSDATE, 'IW') AND TRUNC(SYSDATE, 'IW') + 6
        ORDER BY a.nurse_id, b.SCHE_DATE
    </select>
</mapper>